"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const I=require("marked");var s=(t=>(t.Heading="heading",t.Paragraph="paragraph",t.List="list",t.ListItem="list_item",t.Blockquote="blockquote",t.Code="code",t.CodeSpan="codespan",t.Table="table",t.Html="html",t.Hr="hr",t.Image="image",t.Link="link",t.Strong="strong",t.Em="em",t.TableHeader="table_header",t.TableCell="table_cell",t.Raw="raw",t.Text="text",t))(s||{});const F=async t=>{const a=await I.marked.lexer(t,{async:!0});return d(a)},d=t=>{const a=[];return t.forEach(e=>{try{const n=T[e.type];n?a.push(n(e)):a.push({type:s.Raw,content:e.raw})}catch(n){console.error("Failed to handle token ==>",e,n)}}),a},T={[s.Heading]:t=>({type:s.Heading,depth:t.depth,content:t.text,items:t.tokens?d(t.tokens):[]}),[s.Paragraph]:t=>({type:s.Paragraph,content:t.text,items:t.tokens?d(t.tokens):[]}),[s.List]:t=>({type:s.List,ordered:t.ordered,start:t.start,items:t.items?d(t.items):[]}),[s.ListItem]:t=>({type:s.ListItem,content:t.text,items:t.tokens?d(t.tokens):[]}),[s.Code]:t=>({type:s.Code,lang:t.lang,code:t.text}),[s.Table]:t=>({type:s.Table,header:t.header.map(a=>({type:s.TableHeader,content:a})),rows:t.rows.map(a=>a.map(e=>({type:s.TableCell,content:e})))}),[s.Image]:t=>({type:s.Image,src:t.href,alt:t.text}),[s.Link]:t=>({type:s.Link,href:t.href,text:t.text,items:t.tokens?d(t.tokens):[]}),[s.Strong]:t=>({type:s.Strong,content:t.text,items:t.tokens?d(t.tokens):[]}),[s.Em]:t=>({type:s.Em,content:t.text,items:t.tokens?d(t.tokens):[]}),[s.Text]:t=>({type:s.Text,content:t.text,items:t.tokens?d(t.tokens):[]}),[s.Hr]:t=>({type:s.Hr,content:t.raw,items:t.tokens?d(t.tokens):[]}),[s.CodeSpan]:t=>({type:s.CodeSpan,content:t.text,items:t.tokens?d(t.tokens):[]})},m=(t,a)=>{var e,n;typeof a.pageBreakHandler=="function"?a.pageBreakHandler():t.addPage((e=a.page)==null?void 0:e.format,(n=a.page)==null?void 0:n.orientation)},p=(t,a)=>t.getTextDimensions("H").h*a.page.defaultLineHeightFactor,E=(t,a,e,n,i,g)=>{const x=6-((a==null?void 0:a.depth)??0)>0?6-((a==null?void 0:a.depth)??0):0;if(t.setFontSize(i.page.defaultFontSize+x),a!=null&&a.items&&(a==null?void 0:a.items.length)>0)for(const f of(a==null?void 0:a.items)??[])e=g(f,n,!1);else t.text((a==null?void 0:a.content)??"",e.x+n,e.y,{align:"left",maxWidth:i.page.maxContentWidth-n}),e.y+=1.5*p(t,i);return t.setFontSize(i.page.defaultFontSize),e},P=(t,a,e,n,i,g,x,f,y)=>{const r=(f-e)/(a.length-1);let l=i;const h=g+n*x;for(const b of a)t.text(b.text,l,h,{align:"justify",lineHeightFactor:y,maxWidth:f}),l+=b.wordLength+r},j=(t,a,e,n,i,g,x,f)=>{const y=t.map(r=>r.text).join(" ");a.text(y,e,n+i*g,{align:"justify",lineHeightFactor:f,maxWidth:x})},W=(t,a,e,n,i,g)=>{const x={x:e,y:n},f=t.getTextDimensions("A").h*g,y=a.split(" ");let r=0,l=[],h=0;for(const b of y){const C=t.getTextWidth(b+"a");C+h>=i&&(P(t,l,h,r++,e,n,f,i,g),l=[],h=0),l.push({text:b,wordLength:C}),h+=C}return l.length>0&&j(l,t,e,n,r,f,i,g),x.y=n+r*f,x.x=t.getTextWidth(a)+e,x},D=(t,a,e,n,i,g)=>{t.setFontSize(i.page.defaultFontSize);let x=a.content;const f=t.getTextDimensions("A").h*i.page.defaultLineHeightFactor;if(a!=null&&a.items&&(a==null?void 0:a.items.length)>0)for(const y of(a==null?void 0:a.items)??[])e=g(y,n,!1);else{if(e.y+t.splitTextToSize(x??"",i.page.maxContentWidth-n).length*f-3*f>=i.page.maxContentHeight){const y=t.splitTextToSize(x??"",i.page.maxContentWidth-n),r=[],l=e.y;for(let h=0;h<y.length;h++)if(e.y-2*f<i.page.maxContentHeight)r.push(y[h]),e.y+=i.page.lineSpace;else{h<=y.length-1&&(x=y.slice(h).join(""));break}r.length>0&&(e=W(t,r.join(" "),e.x+n,l,i.page.maxContentWidth-n,i.page.defaultLineHeightFactor)),m(t,i),e.y=i.page.topmargin}e.y=W(t,x??"",e.x+n,e.y,i.page.maxContentWidth-n,i.page.defaultLineHeightFactor).y+p(t,i),e.x=i.page.xpading}return e},R=(t,a,e,n,i,g)=>{var x;t.setFontSize(i.page.defaultFontSize);for(const[f,y]of((x=a==null?void 0:a.items)==null?void 0:x.entries())??[]){const r=a.ordered?(a.start??0)+f:a.start;e=g(y,n+1,!0,r,a.ordered),e.y+=p(t,i)*.2}return e},c=(t,a,e,n,i)=>{const g=t.getFont().fontName,x=t.getFont().fontStyle,f=t.getFontSize(),y=l=>{switch(l){case"normal":return 0;case"bold":return 1;case"italic":return 1.5;case"bolditalic":return 1.5;default:return 0}},r=(l,h)=>{var S;h==="bold"?t.setFont(i.font.bold.name&&i.font.bold.name!==""?i.font.bold.name:g,i.font.bold.style||"bold"):h==="italic"?t.setFont(i.font.regular.name,"italic"):h==="bolditalic"?t.setFont(i.font.bold.name&&i.font.bold.name!==""?i.font.bold.name:g,"bolditalic"):t.setFont(i.font.regular.name,x);const b=i.page.maxContentWidth-n-e.x,C=t.splitTextToSize(l,b);if(C.length>1){const L=C[0],w=(S=C==null?void 0:C.slice(1))==null?void 0:S.join(" ");t.text(L,e.x+(n>=2?n+2*y(h):0),e.y,{baseline:"top",maxWidth:b}),e.x=n,e.y+=p(t,i);const H=i.page.maxContentWidth-n-i.page.xpading-i.page.xmargin;t.splitTextToSize(w,H).forEach(z=>{t.text(z,e.x+n,e.y,{baseline:"top",maxWidth:H}),e.x=n,e.y+=p(t,i)})}else t.text(l,e.x+n,e.y,{baseline:"top",maxWidth:b}),e.x+=t.getTextDimensions(l).w+(n>=2?l.split(" ").length+2:2)*y(h)};if(a.type==="text"&&a.items&&a.items.length>0)for(const l of a.items)if(l.type==="em"||l.type==="strong"){const h=l.type==="em"?"italic":"bold";if(l.items&&l.items.length>0)for(const b of l.items)b.type==="strong"&&h==="italic"||b.type==="em"&&h==="bold"?r(b.content||"","bolditalic"):r(b.content||"",h);else r(l.content||"",h)}else r(l.content||"","normal");else a.type==="em"?r(a.content||"","italic"):a.type==="strong"?r(a.content||"","bold"):r(a.content||"","normal");return t.setFont(g,x),t.setFontSize(f),e},u=(t,a,e,n,i,g,x,f)=>{const y=n*i.page.indent,r=f?`${x}. `:"• ";e.y+p(t,i)>=i.page.maxContentHeight&&(m(t,i),e.y=i.page.topmargin),t.setFont(i.font.regular.name,i.font.regular.style),t.text(r,e.x+y,e.y,{baseline:"top"});const l=t.getTextWidth(r);if(e.x+=l,a.items&&a.items.length>0)for(const h of a.items){if(e.y+p(t,i)>=i.page.maxContentHeight&&(m(t,i),e.y=i.page.topmargin),h.type===s.List)g(h,n+1,!0,x,h.ordered??!1);else if(h.type===s.ListItem){const b=a.type===s.List?n:n+1;g(h,b,!0,x,f)}else e=c(t,h,e,y,i);e.x=i.page.xpading,e.y+=p(t,i)}else if(a.content){const h=t.splitTextToSize(a.content,i.page.maxContentWidth-y-e.x);t.text(h,e.x+y,e.y,{baseline:"top",maxWidth:i.page.maxContentWidth-y-e.x}),e.y+=p(t,i)*h.length,e.x=i.page.xmargin+y;const b=t.getTextWidth(a.content);e.x+=b}return e},B=(t,a,e,n,i,g,x,f,y,r=!0)=>{if(a!=null&&a.items&&(a==null?void 0:a.items.length)>0)for(const l of(a==null?void 0:a.items)??[])e=x(l,n,i,f,y,r);else{const l=n*g.page.indent,h=i?y?`${f}. `:"• ":"",b=t.splitTextToSize(h+a.content,g.page.maxContentWidth-l);e.y+b.length*p(t,g)>=g.page.maxContentHeight&&(m(t,g),e.y=g.page.topmargin),r?(e.y=W(t,h+a.content,e.x+l,e.y,g.page.maxContentWidth-l,g.page.defaultLineHeightFactor).y+p(t,g),e.x=g.page.xpading):(t.text(h+a.content,e.x+l,e.y,{baseline:"top"}),e.x+=t.getTextWidth(h+a.content),e.x>=g.page.xpading+g.page.maxContentWidth&&(m(t,g),e.x=g.page.xpading,e.y=g.page.topmargin))}return e},_=(t,a,e)=>{const n=t.internal.pageSize.getWidth();return t.setLineDashPattern([1,1],0),t.setLineWidth(.1),t.line(e.page.xpading,a.y,n-e.page.xpading,a.y),t.setLineWidth(.1),t.setLineDashPattern([],0),a.y+=p(t,e),a},q=(t,a,e,n,i,g)=>{const x=n*g.page.indent;e.y+t.splitTextToSize(a.code??"",g.page.maxContentWidth-x).length*p(t,g)-2*p(t,g)>=g.page.maxContentHeight&&(m(t,g),e.y=g.page.topmargin);const f=t.splitTextToSize(a.code??"",g.page.maxContentWidth-x).length*p(t,g);return e.y+=g.page.lineSpace,t.setFillColor("#EEEEEE"),t.setDrawColor("#eee"),t.roundedRect(e.x,e.y-g.page.lineSpace,g.page.maxContentWidth,f,2,2,"FD"),t.setFontSize(10),t.text(a.lang??"",e.x+g.page.maxContentWidth-t.getTextWidth(a.lang??"")-g.page.lineSpace/2,e.y),t.setFontSize(g.page.defaultFontSize),t.text(a.code??"",e.x+4,e.y),e.y+=f,e},J=async(t,a,e)=>{const n=await F(a);console.log(n);let i={x:e.cursor.x,y:e.cursor.y};const g=(x,f=0,y=!1,r=0,l=!1,h=!0)=>{const b=f*e.page.indent;switch(i.y+t.splitTextToSize(x.content??"",e.page.maxContentWidth-b).length*p(t,e)>=e.page.maxContentHeight&&(m(t,e),i.y=e.page.topmargin),x.type){case s.Heading:i=E(t,x,i,b,e,g);break;case s.Paragraph:i=D(t,x,i,b,e,g);break;case s.List:i=R(t,x,i,f,e,g);break;case s.ListItem:i=u(t,x,i,f,e,g,r,l);break;case s.Hr:i=_(t,i,e);break;case s.Code:i=q(t,x,i,f,y,e);break;case s.Strong:case s.Em:i=c(t,x,i,b,e);break;case s.Raw:case s.Text:i=B(t,x,i,f,y,e,g,r,l,h);break;default:console.warn(`Warning: Unsupported element type encountered: ${x.type}. 
                    If you believe this element type should be supported, please create an issue at:
                    https://github.com/JeelGajera/jspdf-md-renderer/issues
                    with details of the element and expected behavior. Thank you for helping improve this library!`);break}return i};for(const x of n)g(x);e.endCursorYHandler(i.y)};exports.MdTextParser=F;exports.MdTextRender=J;
